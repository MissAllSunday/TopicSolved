<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>Suki:TopicSolved</id>
	<version>1.2</version>
	<file name="$sourcedir/Admin.php">

		<!-- There is no hook for this on 2.0... -->
		<operation>
			<search position="replace"><![CDATA[$sub_action =]]></search>
			<add><![CDATA[call_integration_hook('integrate_manage_logs', array($log_functions));

	$sub_action =]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['modlog' => array(
				'description' => $txt['moderation_log_desc'],
			),]]></search>
			<add><![CDATA['modlog' => array(
				'description' => $txt['moderation_log_desc'],
			),
			'topicsolvedlog' => array(
				'description' => $txt['topic_solved_desc'],
			),]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Display.php">
		<operation>
			<search position="replace"><![CDATA[$context['topic_first_message'] = $topicinfo['id_first_msg'];]]></search>
			<add><![CDATA[$context['topic_first_message'] = $topicinfo['id_first_msg'];
	$context['topic_solved'] = $topicinfo['is_solved'];
	$context['can_solve_topic'] =  (allowedTo('solve_topic_any') || (allowedTo('solve_topic_own') && $user_info['id'] == $topicinfo['id_member_started'])) && $board_info['topic_solved'];]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[t.num_replies, t.num_views, t.locked, ms.subject, t.is_sticky]]></search>
			<add><![CDATA[t.num_replies, t.num_views, t.locked, ms.subject, t.is_sticky, t.is_solved]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Load.php">
		<operation>
			<search position="replace"><![CDATA[b.override_theme, b.count_posts]]></search>
			<add><![CDATA[b.override_theme, b.count_posts, b.topic_solved]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['posts_count' => empty($row['count_posts']),]]></search>
			<add><![CDATA['posts_count' => empty($row['count_posts']),
				'topic_solved' => $row['topic_solved'],]]></add>
		</operation>
	</file>
	<file name="$sourcedir/ManageBoards.php">
		<operation>
			<search position="replace"><![CDATA[$boardOptions['posts_count'] = isset($_POST['count']);]]></search>
			<add><![CDATA[$boardOptions['posts_count'] = isset($_POST['count']);
		$boardOptions['topic_solved'] = isset($_POST['topic_solved']);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['count_posts' => 1,]]></search>
			<add><![CDATA['count_posts' => 1,
			'topic_solved' => 0,]]></add>
		</operation>
	</file>
	<file name="$sourcedir/ManagePermissions.php">
		<operation>
			<search position="replace"><![CDATA['remove_own',
		'view_attachments',]]></search>
			<add><![CDATA['remove_own',
		'view_attachments',
		'solve_topic_own',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['poll_add_any',
		'approve_posts',]]></search>
			<add><![CDATA['poll_add_any',
		'approve_posts',
		'solve_topic_any',]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['send_topic' => array(false, 'topic', 'moderate'),]]></search>
			<add><![CDATA['send_topic' => array(false, 'topic', 'moderate'),
			'solve_topic' => array(true, 'topic', 'moderate'),]]></add>
		</operation>
	</file>
	<file name="$sourcedir/MessageIndex.php">
		<operation>
			<search position="replace"><![CDATA[$context['can_restore'] = allowedTo('move_any') && !empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] == $board;]]></search>
			<add><![CDATA[$context['can_restore'] = allowedTo('move_any') && !empty($modSettings['recycle_enable']) && $modSettings['recycle_board'] == $board;
		$context['can_solve'] = allowedTo('solve_topic_any') && !empty($board_info['topic_solved']);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['approve' => $context['can_approve'] && $topic['unapproved_posts']]]></search>
			<add><![CDATA[				'approve' => $context['can_approve'] && $topic['unapproved_posts'],
				'solve' => (allowedTo('solve_topic_any') || ($started && allowedTo('solve_topic_own'))) && !empty($board_info['topic_solved'])]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[$context['can_remove'] |= ($started && allowedTo('remove_own'));]]></search>
			<add><![CDATA[			$context['can_remove'] |= ($started && allowedTo('remove_own'));
			$context['can_solve'] |= ($started && allowedTo('remove_own')) && !empty($board_info['topic_solved']);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['approve_posts' => allowedTo('approve_posts') ? array($board) : array(),]]></search>
			<add><![CDATA[			'approve_posts' => allowedTo('approve_posts') ? array($board) : array(),
			'solve_any' => allowedTo('solve_topic_any') ? array($board) : array(),
			'solve_own' => allowedTo('solve_topic_own') ? array($board) : array(),]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['approve_posts' => boardsAllowedTo('approve_posts'),]]></search>
			<add><![CDATA[			'approve_posts' => boardsAllowedTo('approve_posts'),
			'solve_any' => boardsAllowedTo('solve_topic_any'),
			'solve_own' => boardsAllowedTo('solve_topic_own'),]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[$possibleActions[] = 'approve';]]></search>
			<add><![CDATA[$possibleActions[] = 'approve';
	if (!empty($boards_can['solve_any']) || !empty($boards_can['solve_own']))
		$possibleActions[] = 'solve';]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[elseif ($_REQUEST['actions'][$row['id_topic']] == 'approve' && (!$row['unapproved_posts'] || (!in_array(0, $boards_can['approve_posts']) && !in_array($row['id_board'], $boards_can['approve_posts']))))
					unset($_REQUEST['actions'][$row['id_topic']]);]]></search>
			<add><![CDATA[elseif ($_REQUEST['actions'][$row['id_topic']] == 'approve' && (!$row['unapproved_posts'] || (!in_array(0, $boards_can['approve_posts']) && !in_array($row['id_board'], $boards_can['approve_posts']))))
					unset($_REQUEST['actions'][$row['id_topic']]);
				elseif ($_REQUEST['actions'][$row['id_topic']] == 'solve' && !in_array(0, $boards_can['solve_any']) && !in_array($row['id_board'], $boards_can['solve_any']) && ($row['id_member_started'] != $user_info['id'] || (!in_array(0, $boards_can['solve_own']) && !in_array($row['id_board'], $boards_can['solve_own']))))
					unset($_REQUEST['actions'][$row['id_topic']]);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[$approveCache = array();]]></search>
			<add><![CDATA[$approveCache = array();
	$solveCache = array();]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[$approveCache[] = $topic;]]></search>
			<add><![CDATA[$approveCache[] = $topic;
		elseif ($action == 'solve')
			$solveCache[] = $topic;]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[foreach ($moveCache as $topic)]]></search>
			<add><![CDATA[if (!empty($solveCache))
	{
		$solvePosts = array();
		$solveStatus = array();

		$result = $smcFunc['db_query']('', '
			SELECT t.id_topic, t.id_board, t.id_first_msg, t.is_solved, b.topic_solved
			FROM {db_prefix}topics AS t
				LEFT JOIN {db_prefix}boards AS b ON (b.id_board = t.id_board)
			WHERE t.id_topic IN ({array_int:solve_topic_ids})
				AND b.topic_solved = {int:topic_solved}' . (!empty($board) && !allowedTo('solve_topic_any') ? '
				AND t.id_member_started = {int:current_member}' : '') . '
			LIMIT ' . count($solveCache),
			array(
				'current_member' => $user_info['id'],
				'solve_topic_ids' => $solveCache,
				'topic_solved' => 1,
			)
		);
		$solveCache = array();
		$solveCacheBoards = array();
		while ($row = $smcFunc['db_fetch_assoc']($result))
		{
			$solveCache[] = $row['id_topic'];
			$solvePosts[] = $row['id_first_msg'];
			$solveStatus[$row['id_topic']] = empty($row['is_solved']);
			$solveCacheBoards[$row['id_topic']] = $row['id_board'];
		}
		$smcFunc['db_free_result']($result);

		if (!empty($solveCache))
		{
			$smcFunc['db_query']('', '
				UPDATE {db_prefix}topics
				SET is_solved = CASE WHEN is_solved = {int:is_solved} THEN 0 ELSE 1 END
				WHERE id_topic IN ({array_int:solve_topic_ids})',
				array(
					'solve_topic_ids' => $solveCache,
					'is_solved' => 1,
				)
			);

			$smcFunc['db_query']('', '
				UPDATE {db_prefix}messages
				SET icon = CASE WHEN icon = {string:topic_solved} THEN {string:normal} ELSE {string:topic_solved} END
				WHERE id_msg IN ({array_int:solve_post_ids})',
				array(
					'solve_post_ids' => $solvePosts,
					'topic_solved' => 'topicsolved',
					'normal' => 'xx',
				)
			);
		}
	}

	foreach ($moveCache as $topic)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[foreach ($stickyCache as $topic)
	{
		logAction($stickyCacheStatus[$topic] ? 'unsticky' : 'sticky', array('topic' => $topic, 'board' => $stickyCacheBoards[$topic]));
		sendNotifications($topic, 'sticky');
	}]]></search>
			<add><![CDATA[foreach ($stickyCache as $topic)
	{
		logAction($stickyCacheStatus[$topic] ? 'unsticky' : 'sticky', array('topic' => $topic, 'board' => $stickyCacheBoards[$topic]));
		sendNotifications($topic, 'sticky');
	}
	foreach ($solveCache as $topic)
		logAction($solveStatus[$topic] ? 'solve' : 'not_solve', array('topic' => $topic, 'board' => $solveCacheBoards[$topic]), 'topic_solved');]]></add>
		</operation>
	</file>
	<file name="$sourcedir/ModerationCenter.php">
		<operation>
			<search position="replace"><![CDATA['modlog' => array(
					'label' => $txt['modlog_view'],
					'enabled' => !empty($modSettings['modlog_enabled']) && $context['can_moderate_boards'],
					'file' => 'Modlog.php',
					'function' => 'ViewModlog',
				),]]></search>
			<add><![CDATA['modlog' => array(
					'label' => $txt['modlog_view'],
					'enabled' => !empty($modSettings['modlog_enabled']) && $context['can_moderate_boards'],
					'file' => 'Modlog.php',
					'function' => 'ViewModlog',
				),
				'topicsolvedlog' => array(
					'enabled' => !empty($modSettings['modlog_enabled']),
					'label' => $txt['topic_solved_log'],
					'file' => 'Modlog.php',
					'function' => 'ViewModlog',
				),]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Modlog.php">
		<operation>
			<search position="replace"><![CDATA[$context['log_type'] = isset($_REQUEST['sa']) && $_REQUEST['sa'] == 'adminlog' ? 3 : 1;]]></search>
			<add><![CDATA[	$context['log_type'] = isset($_REQUEST['sa']) && $_REQUEST['sa'] == 'adminlog' ? 3 : ((isset($_REQUEST['area']) && $_REQUEST['area'] == 'topicsolvedlog') || (isset($_REQUEST['sa']) && $_REQUEST['sa'] == 'topicsolvedlog') || (isset($_REQUEST['type']) && $_REQUEST['type'] == 4) ? 4 : 1);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[$context['url_start'] = '?action=admin;area=logs;sa=' . ($context['log_type'] == 3 ? 'adminlog' : 'modlog') . ';type=' . $context['log_type'];]]></search>
			<add><![CDATA[$context['url_start'] = '?action=admin;area=logs;sa=' . ($context['log_type'] == 3 ? 'adminlog' : ($context['log_type'] == 4 ? 'topicsolvedlog' : 'modlog')) . ';type=' . $context['log_type'];]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[$context['page_title'] = $context['log_type'] == 3 ? $txt['modlog_admin_log'] : $txt['modlog_view'];]]></search>
			<add><![CDATA[	$context['page_title'] = $context['log_type'] == 3 ? $txt['modlog_admin_log'] : ($context['log_type'] == 4 ? $txt['topic_solved_log'] : $txt['modlog_view']);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['title' => '<a href="' . $scripturl . '?action=helpadmin;help=' . ($context['log_type'] == 3 ? 'adminlog' : 'modlog') . '" onclick="return reqWin(this.href);" class="help"><img src="' . $settings['images_url'] . '/helptopics.gif" alt="' . $txt['help'] . '" align="top" /></a> ' . $txt['modlog_' . ($context['log_type'] == 3 ? 'admin' : 'moderation') . '_log'],]]></search>
			<add><![CDATA['title' => $context['log_type'] == 4 ? $txt['topic_solved_log'] : ('<a href="' . $scripturl . '?action=helpadmin;help=' . ($context['log_type'] == 3 ? 'adminlog' : 'modlog') . '" onclick="return reqWin(this.href);" class="help"><img src="' . $settings['images_url'] . '/helptopics.gif" alt="' . $txt['help'] . '" align="top" /></a> ' . $txt['modlog_' . ($context['log_type'] == 3 ? 'admin' : 'moderation') . '_log']),]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['value' => $txt['modlog_' . ($context['log_type'] == 3 ? 'admin' : 'moderation') . '_log_desc'],]]></search>
			<add><![CDATA['value' => $txt['modlog_' . ($context['log_type'] == 3 ? 'admin' : ($context['log_type'] == 4 ? 'topicsolved' : 'moderation')) . '_log_desc'],]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Subs.php">
		<operation>
			<search position="replace"><![CDATA['admin' => 3,]]></search>
			<add><![CDATA['admin' => 3,
		'topic_solved' => 4,]]></add>
		</operation>
	</file>
	<file name="$sourcedir/Subs-Boards.php">
		<operation>
			<search position="replace"><![CDATA[// Set the theme for this board.]]></search>
			<add><![CDATA[if (isset($boardOptions['topic_solved']))
	{
		$boardUpdates[] = 'topic_solved = {int:topic_solved}';
		$boardUpdateParameters['topic_solved'] = $boardOptions['topic_solved'] ? 1 : 0;
	}

	// Set the theme for this board.]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[b.board_order, b.count_posts]]></search>
			<add><![CDATA[b.board_order, b.count_posts, b.topic_solved]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA['count_posts' => empty($row['count_posts']),]]></search>
			<add><![CDATA['count_posts' => empty($row['count_posts']),
				'topic_solved' => $row['topic_solved'],]]></add>
		</operation>
	</file>
	<file name="$themedir/Display.template.php">
		<operation>
			<search position="replace"><![CDATA[$mod_buttons[] = array('text' => 'restore_topic', 'image' => '', 'lang' => true, 'url' => $scripturl . '?action=restoretopic;topics=' . $context['current_topic'] . ';' . $context['session_var'] . '=' . $context['session_id']);]]></search>
			<add><![CDATA[$mod_buttons[] = array('text' => 'restore_topic', 'image' => '', 'lang' => true, 'url' => $scripturl . '?action=restoretopic;topics=' . $context['current_topic'] . ';' . $context['session_var'] . '=' . $context['session_id']);

	// The Topic Solved button.
	if ($context['can_solve_topic'])
		$mod_buttons[] = array('text' => $context['topic_solved'] ? 'topic_not_solved' : 'topic_solved', 'image' => '', 'lang' => true, 'url' => $scripturl . '?action=topicsolved;topic=' . $context['current_topic'] . ';sesc=' . $context['session_id']);]]></add>
		</operation>
	</file>
	<file name="$themedir/ManageBoards.template.php">
		<operation>
			<search position="replace"><![CDATA[document.getElementById("board_theme_div").style.display = redirectEnabled ? "none" : "";]]></search>
			<add><![CDATA[document.getElementById("board_theme_div").style.display = redirectEnabled ? "none" : "";
			document.getElementById("topic_solved_div").style.display = redirectEnabled ? "none" : "";]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[// Here the user can choose to force this board to use a theme other than the default theme for the forum.]]></search>
			<add><![CDATA[echo '
					<div id="topic_solved_div">
						<dl class="settings">
							<dt>
								<strong>', $txt['topic_solved_board'], ':</strong><br />
								<span class="smalltext">', $txt['topic_solved_board_desc'], '</span><br />
							</dt>
							<dd>
								<input type="checkbox" name="topic_solved" ', $context['board']['topic_solved'] ? ' checked="checked"' : '', ' class="input_check" />
							</dd>
						</dl>
					</div>';

	// Here the user can choose to force this board to use a theme other than the default theme for the forum.]]></add>
		</operation>
	</file>
	<file name="$themedir/MessageIndex.template.php">
		<operation>
			<search position="replace"><![CDATA[<option value="restore">' . $txt['quick_mod_restore'] . '</option>' : '', $context['can_approve'] ? ']]></search>
			<add><![CDATA[<option value="restore">' . $txt['quick_mod_restore'] . '</option>' : '', $context['can_solve'] ? '
							<option value="solve">' . $txt['topic_solved_quick'] . '</option>' : '', $context['can_approve'] ? ']]></add>
		</operation>
	</file>
</modification>